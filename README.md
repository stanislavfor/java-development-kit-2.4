![](assets/_logo_min_.png)
# Java Development Kit (семинары)
# Урок 4. Коллекции

#### Описание и цели семинара
Выполнение практических и тестовых заданий в соответствии с презентацией к уроку
1. Демонстрация основных концепций многопоточности на примерах: создание и запуск потоков, синхронизация, взаимодействие потоков.
2. Обсуждение паттернов проектирования в многопоточных приложениях.
3. Практическая работа студентов: реализация задач, связанных с многопоточной обработкой данных.
4. Анализ и обсуждение выполненных заданий.

<br><br><hr>
## Домашнее задание
Создать справочник сотрудников. <br>
Необходимо: <br>
- Создать класс справочник сотрудников, который содержит внутри коллекцию сотрудников. <br>
  Каждый сотрудник должен иметь следующие атрибуты:
    - Табельный номер
    - Номер телефона
    - Имя
    - Стаж
- Добавить метод, который ищет сотрудника по стажу (может быть список)
- Добавить метод, который возвращает номер телефона сотрудника по имени (может быть список)
- Добавить метод, который ищет сотрудника по табельному номеру
- Добавить метод добавления нового сотрудника в справочник

<br><br><hr>
## Решение задания

### Запуск приложения


Команда Maven для установки зависимостей:
```bash
mvn clean install
```
Использовать команду для запуска Spring Boot приложения, которое будет доступно на порту 8080:
```bash
mvn spring-boot:run
```

Приложение учета сотрудников позволяет управлять информацией о сотрудниках, включая добавление, поиск и удаление записей. <br>
Приложение для взаимодействия с пользователем имеет консольный интерфейс. <br>
После запуска приложения, появляется меню со следующими опциями:
```
Меню:
                    1. Добавить сотрудника
                    2. Найти сотрудников по опыту работы
                    3. Найти телефон по имени сотрудника
                    4. Удалить сотрудника
                    5. СПИСОК всех сотрудников
                    6. Редактировать данные сотрудника
                    0. Выход
```
Приложение использует базу данных H2, которая запускается в памяти. <br>
Настройки базы данных указаны в файле `application.properties`. <br>
Для доступа к консоли H2: <br>
- Перейти по следующему URL в браузере: http://localhost:8080/api/h2-console
- Использовать следующие учетные данные для входа:
    - JDBC URL: `jdbc:h2:file:./data/db`
    - User Name: `sa`
    - Password: (оставить пустым)


Приложение для взаимодействия с данными имеет REST API. <br>
**Основные маршруты URL в браузере**:

- Добавление сотрудника
    - Метод: POST
    - URL: http://localhost:8080/api/employees
    - Тело запроса: JSON объект с данными сотрудника
    - Пример запроса:
      ```bash
       curl -X POST -H "Content-Type: application/json" -d '{"id": 1, "phoneNumber": "+79991234567", "employeeName": "Ивановский Петр", "workExperience": 5}' http://localhost:8080/api/employees
      ```

- Поиск сотрудников по опыту работы
    - Метод: GET
    - URL: `http://localhost:8080/api/employees/experience/{experience}`
    - Пример запроса:
      ```bash
       curl -X GET http://localhost:8080/api/employees/experience/5
      ```

- Поиск телефонных номеров по имени сотрудника

    - Метод: GET
    - URL: `http://localhost:8080/api/employees/name/{name}`
    - Пример запроса:
      ```bash
       curl -X GET http://localhost:8080/api/employees/name/Ивановский%20Петр
      ```

- Удаление сотрудника
    - Метод: DELETE
    - URL: `http://localhost:8080/api/employees/{id}`
    - Пример запроса:
     ```bash
      curl -X DELETE http://localhost:8080/api/employees/1
     ```

**Примеры использования данного приложения**:

1. Добавление сотрудника
      ```bash
      curl -X POST -H "Content-Type: application/json" -d '{"id": 1, "phoneNumber": "+79991234567", "employeeName": "Ивановский Петр", "workExperience": 5}' http://localhost:8080/api/employees
      ```

2. Поиск сотрудников по опыту работы
      ```bash
      curl -X GET http://localhost:8080/api/employees/experience/5
      ```

3. Поиск телефонных номеров по имени сотрудника
      ```bash
      curl -X GET http://localhost:8080/api/employees/name/Ивановский%20Петр
      ```

4. Удаление сотрудника
      ```bash
      curl -X DELETE http://localhost:8080/api/employees/1
      ```

Главный класс приложения Application имеет аннотацию @SpringBootApplication. <br>
Эта аннотация включает в себя @Configuration, @EnableAutoConfiguration и @ComponentScan, <br>
что позволяет автоматически регистрировать <a href="#bean">бины</a>. <br>

<br><br><hr>
## Дополнительная информация

Для добавления в проект использование базы данных H2, понадобится:
1. Подключить библиотеку H2.
2. Настроить подключение к базе данных.
3. Создать таблицы и сущности в базе данных.
4. Написать методы CRUD (создание, чтение, обновление, удаление) для сущностей.
5. Интегрировать новые методы в существующую логику приложения.


### Таблица EMPLOYEES

SQL-запросы для создания таблицы EMPLOYEES:
```
  CREATE TABLE IF NOT EXISTS employees (
     id INT AUTO_INCREMENT PRIMARY KEY,
     phone_number VARCHAR(20),
     employee_name VARCHAR(100),
     work_experience INT
);
```
, где EMPLOYEES таблица с четырьмя колонками: <br>
- id - автоинкрементируемый первичный ключ с автоинкриментом;
- phone_number - строка для хранения номера телефона;
- employee_name - строка для хранения полного имени сотрудника;
- work_experience - целое число для обозначения стажа работы.

### Подключение к базе данных H2

#### 1. Открыть окна Data Sources & Drivers
- Открыть вкладку **Database**, если её нет слева, нажать комбинацию клавиш `Ctrl + Alt + Shift + S` или зайти в меню **View -> Tool Windows → Database**.
- Щёлкнуть правой кнопкой мыши по корневому узлу базы данных и выбрать пункт **"Data Source" -> "H2"**. Появится окно настройки драйвера и источника данных.

#### 2. Выбор драйвера H2
- Проверить, что установлен нужный драйвер для H2. В разделе **Drivers** в верхней части окна щелкнуть на иконку плюса (+) рядом с надписью **Drivers** и там выбрать **H2**.
- Нажать на кнопку загрузки драйвера справа от списка драйверов (**Download**) и скачать подходящий драйвер последнюю стабильную версию.

#### 3. Настройка источника данных
- В окне настроек источника данных, заполнить поля:

##### a) Тип подключения:
- Если используется **In-Memory** базы данных, хранящуюся в оперативной памяти:
    - В поле **URL** вписать путь: ``` jdbc:h2:mem:testdb  ```
    - Параметры аутентификации:
        - Имя пользователя: `sa`
        - Пароль: оставить пустым или указать любой пароль, но необязательно для in-memory режима.
    - Загрузка драйвера:
        - Проверить, что драйвер H2 загружен, либо нажать на кнопку `Download missing driver files`.
    - Тестирование подключения:
        - Нажать на кнопку `Test Connection`, чтобы проверить, что подключение к базе данных работает.


##### b) Локальная файловая база данных:
- Если использовать локальную файловую базы данных, написать URL:
  ```
  jdbc:h2:/path/to/db/file/my_db_file
  ```
  , где `/path/to/db/file/my_db_file` - абсолютный путь к файлу базы данных на компьютере.

- Поля аутентификации указать аналогичны In-Memory варианту.
    - Имя пользователя: `sa`
    - Пароль

#### 4. Сохранение настроек
- Нажать кнопку **Test connection**, чтобы проверить, что соединение установлено верно.
- Затем нажать **Apply** и **OK**, чтобы сохранить настройки.

#### 5. Работа с базой данных
- База данных появится в окне инструментов **Databases** в левой панели.
- Далее проверить структуру таблиц, создавать новые объекты и выполнить SQL-запросы.



### Пример настроенного подключения:

- Пример URL для in-memory базы данных, которая не сохраняется после перезагрузки:
```
jdbc:h2:mem:testdb
```
- Пример URL для локальной файловой базы данных:
```
jdbc:h2:/home/user/h2-database/test.db
```

### Использование встроенных утилит H2:

H2 имеет встроенную веб-консоль, которая помогает управлять базой данных непосредственно из браузера.

- Чтобы запустить консоль, открыть терминал и выполнить команду:
  ```
  java -cp path_to_h2_jar org.h2.tools.Console
  ```
- Далее открыть браузер и перейти по адресу http://localhost:8082/.
- Там ввести нужные параметры подключения (URL, username/password) и перейти к управлению базой данных.

**Примечание**: Порт 8082 может использоваться в разных целях, например, <br>
в веб-разработке как альтернатива порту 8080, если основной порт занят, или для дополнительных <br>
сервисов веб-приложений. <br>
Для веб-сервера базы данных H2 - предоставляет доступ к функциям выполнения SQL-запросов. <br>


### Примеры настройки application.properties

- Для H2 в памяти внешних соединений не требуется, так как всё находится локально (в Spring Boot проекте):
```
spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
```
, где jdbc:h2:mem:testdb - база данных из встроенной памяти,
или jdbc:h2:file:./data/demo-db - путь к базе данных от корневой директории.

- Для PostgreSQL требуется указать URL и драйвер подключения:
```
spring.datasource.url=jdbc:postgresql://localhost:5432/my_database
spring.datasource.username=postgres
spring.datasource.password=mypassword
spring.datasource.driver-class-name=org.postgresql.Driver
```

- **Ключевые параметры**:
    - spring.datasource. - Настройки подключения к базе данных:
        - url: адрес подключения к базе данных (пример для H2 in-memory).
        - driver-class-name: драйвер базы данных (для H2 — org.h2.Driver).
        - username, password: учетные данные для доступа к базе данных.
        - hibernate.ddl-auto: управляет созданием и обновлением схемы базы данных (update, create, none и т.д.).
    - spring.jpa. - Настройки Hibernate и JPA:
        - database-platform: определяет диалект Hibernate для конкретной базы данных.
        - show-sql: включает показ SQL-запросов в журнале (отладочная информация).
        - server. - Настройки веб-сервера:
            - port: порт, на котором будет работать веб-сервис (по умолчанию 8080).
            - servlet.context-path: базовый путь для всех контроллеров.
        - logging. - Настройки журнализации:
            - pattern.console: настраивает формат логов.
            - file.name: расположение и имя файла журналов.
            - level.*: уровни детализации логов (например, DEBUG, INFO, ERROR).
        - spring.task. - Настройки многопоточной обработки заданий:
            - pool.size, queue.capacity: определяют размер пула потоков и очереди задач соответственно.
        - spring.config. - Внешняя конфигурация (например, загрузка свойств из другого файла).
        - spring.messages. - Управление интернационализацией (i18n).
        - spring.http. - Ограничения размера загружаемого файла.
        - spring.profiles. - Активирует определенный профиль (например, dev, prod).

**Для продакшн-версии следует устанавливать подходящее значение spring.jpa.hibernate.ddl-auto, <br>
например, validate или none, чтобы предотвратить нежелательные изменения структуры базы данных**.

### Проверка тестов

Можно использовать аннотацию @SpringBootTest для загрузки контекста приложения и проверки наличия бинов. <br>
Основной класс EmployeeService находится в пакете com.example.hometask.employeedirectory.service, <br>
значит тестовый класс MyTests должен находиться в том же пакете, но в директории src/test/java. <br>
Запустить тесты с помощью Maven можно, выполнив команду в корневой директории проекта, которая <br>
запустит все тесты, находящиеся в директории src/test/java:
```Copy
mvn test
```
Размещение тестовых классов в директории src/test/java и в соответствующих пакетах позволяет <br>поддерживать корректную структуру проекта, обеспечивать легкий доступ к тестам. <br>Также это соответствует стандартным практикам разработки на Java с использованием Maven.

### Объяснение зависимостей

1. spring-boot-starter-web:
    - Эта зависимость включает все необходимые библиотеки для создания веб-приложений с использованием Spring MVC, включает в себя Spring MVC, Jackson для работы с JSON, и встроенный сервер Tomcat.
2. spring-boot-starter-data-jpa:
    - Эта зависимость включает все необходимые библиотеки для работы с базой данных с использованием Spring Data JPA, включает в себя Hibernate как реализацию JPA.
3. h2:
    - Эта зависимость включает встроенную базу данных H2, которая используется для тестирования и разработки.
4. lombok:
    - Эта зависимость включает библиотеку Lombok, которая предоставляет аннотации для уменьшения шаблонного кода, такого как геттеры, сеттеры, конструкторы и т.д.
5. spring-boot-starter-test:
    - Эта зависимость включает все необходимые библиотеки для тестирования Spring Boot приложений, также JUnit 5, Mockito, AssertJ, Hamcrest и другие библиотеки для тестирования.
6. spring-boot-test:
    - Эта зависимость включает основные библиотеки для тестирования Spring Boot приложений.
7. spring-boot-test-autoconfigure:
    - Эта зависимость включает автоконфигурацию для тестирования Spring Boot приложений.
8. mockito-core:
    - Эта зависимость включает основные библиотеки Mockito для создания моков и шпионов.
9. mockito-junit-jupiter:
    - Эта зависимость включает интеграцию Mockito с JUnit 5 (Jupiter).

### <p id="bean">Бин (bean) в Spring Boot</p>

Бин (bean) в Spring Boot - это объект Java, который управляется IoC-контейнером фреймворка Spring. <br>
Это экземпляр класса, который конфигурируется и контролируется Spring.

1. Назначение бинов:

- Бины обычно представляют собой компоненты или сервисы, используемые в приложении.
- Бины позволяют:
    - автоматически связывать объекты между собой, что упрощает внедрение зависимостей,
    - использовать один объект в разных частях приложения - это обеспечивает переиспользование компонентов.


2. Виды аннотаций для бинов:

- В Spring Boot для создания бинов используются различные аннотации, например:
- @Component - универсальная аннотация для вспомогательных классов.
- @Service - для бизнес-логики.
- @Repository - для работы с данными.
- @Controller или @RestController - для веб-контроллеров (MVC или REST API).
- @Bean - для ручной настройки бинов, часто используется в @Configuration-классе.

3. Примеры использования бинов:

- Пример использования аннотации @Bean для создания бина. В этом примере метод userService() возвращает экземпляр класса UserService, который управляется Spring-контейнером:
 ```
   @Configuration
   public class AppConfig {
       @Bean
       public UserService userService() {
            return new UserServiceImpl();
       }
   }
  ```
- Аннотация @Component в Spring помечает класс как компонент (бин). Это позволяет Spring автоматически обнаружить и зарегистрировать класс в контексте приложения при использовании сканирования классов. В этом примере будет создан компонент типа SimpleBean с именем и идентификатором simpleBean. Контекст Spring автоматически найдёт этот класс и создаст объект этого типа, который будет использоваться для внедрения зависимостей.
  ```
    import org.springframework.stereotype.Component;  

    @Component  
    public class SimpleBean {  
        public String hello() {  
            return "Hello world!";  
        }  
    }  
  ``` 
- Пример использования аннотации @Service в приложении Spring Boot для обозначения класса, выполняющего определённый сервис или функцию. Здесь класс NotificationService аннотирован аннотацией @Service перед именем класса. Это означает, что NotificationService - компонент уровня сервиса (бизнес-логики) и будет содержать основную бизнес-логику службы уведомлений.
  ```
   @Service
   public class NotificationService {
     public void sendNotification(Notification notification) {
        // Код для отправки сообщения уведомления
     }
   }
  ```

- Аннотация @Repository в Spring указывает, что класс предоставляет механизм для хранения, извлечения, обновления, удаления и поиска объектов. Она может использоваться как самостоятельно, так и в сочетании с другими технологиями, например JPA.
    - В примере класс реализует интерфейс ObjectRepository, который определяет методы для работы с объектами. Аннотация @Repository применяется к классу, который не связан с JPA
      ```
      package com.example.dev.repository;  
      import org.springframework.stereotype.Repository;  
      import com.example.dev.model.Employee;
  
      @Repository  
      public class EmployeeRepository implements ObjectRepository<Employee> {  
         // Реализация методов для работы с объектами (хранение, извлечение, поиск, удаление)  
      }
      ```
        - Пример с JPA, где аннотация @Repository используется с JPA, чтобы указать, что класс является репозиторием и должен поддерживаться Spring Data JPA. В этом примере интерфейс UserRepository расширяется от JpaRepository, что позволяет использовать встроенные методы репозитория, например save, findById, findAll.
      ```
      package com.example.spring.repository;  
      import org.springframework.data.jpa.repository.JpaRepository;  
      import org.springframework.stereotype.Repository;  
      import com.example.spring.model.User;
  
      @Repository  
      public interface UserRepository extends JpaRepository<User, Long> {  
         // Методы репозитория (например, `save`, `findById`)  
      }
      ```


<br><br><br><br><hr>
<hr>
<hr>
<hr>